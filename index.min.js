angular.module('transformators', []);

angular.module('dependencies', ['ui.router']);

angular.module('app', ['dependencies', 'transformators']);

angular.module('app').config(function($stateProvider, $urlRouterProvider) {
  $urlRouterProvider.otherwise('/');
  return $stateProvider.state('transformatorCounter', {
    url: '/',
    templateUrl: 'views/transformatorCounter/transformatorCounter.html',
    controller: 'TransformatorCounterController'
  }).state('transformatorReview', {
    url: '/review',
    templateUrl: 'views/transformatorCounter/transformatorReview.html',
    controller: 'TransformatorReviewController'
  }).state('linkMatrix', {
    url: '/link_matrix',
    templateUrl: 'views/linkMatrix/linkMatrix.html',
    controller: 'LinkMatrixController'
  });
});

var LinkMatrixController;

LinkMatrixController = function($scope, $state, Schemas, Transformators, Graph) {
  var drawGraph, linkTargets;
  $scope.targets = Transformators.getTargets();
  Transformators.setTargets($scope.targets);
  $scope.source = Transformators.getSource();
  if (!$scope.targets.length) {
    $state.go('transformatorCounter');
  }
  $scope.changeLink = function(from, to, value) {
    return $scope.targets[from].links[to] = $scope.targets[to].links[from] = value;
  };
  $scope.changeLinkLength = function(from, to, value) {
    return $scope.targets[from].linksLength[to] = $scope.targets[to].linksLength[from] = value;
  };
  drawGraph = function() {
    var maxX, maxY, s;
    $('#graph').remove();
    $('#graph-container').html('<div id="graph" style="height:400px"></div>');
    s = new sigma('graph');
    maxX = _.max(_.map($scope.targets, 'x'));
    if (maxX < $scope.source.x) {
      maxX = $scope.source.x;
    }
    maxY = _.max(_.map($scope.targets, 'y'));
    if (maxY < $scope.source.y) {
      maxY = $scope.source.y;
    }
    _.each($scope.targets, function(target) {
      return s.graph.addNode({
        id: "n" + target.id,
        label: target.label,
        x: target.x,
        y: maxY - target.y,
        size: 3
      });
    });
    s.graph.addNode({
      id: "n" + $scope.targets.length,
      label: $scope.source.label,
      x: $scope.source.x,
      y: maxY - $scope.source.y,
      size: 5,
      color: 'yellow'
    });
    _.each(Graph.getGraph().links, function(link, i) {
      return s.graph.addEdge({
        id: "e" + i,
        source: "n" + link.from,
        target: "n" + link.to
      });
    });
    return s.refresh();
  };
  linkTargets = function() {
    var graph, results;
    results = [];
    while (true) {
      graph = Graph.initGraph($scope.targets.length + 1);
      _.each($scope.targets, function(target) {
        var availableLinks, link, to;
        availableLinks = [];
        _.each(target.links, function(link, index) {
          if (link === 'unblocked') {
            return availableLinks.push(index);
          }
        });
        if (availableLinks.length) {
          to = _.round(availableLinks.length * _.random(0, 1, true));
          if (to === availableLinks.length) {
            to -= 1;
          }
          to = availableLinks[to];
          link = _.find(Graph.getGraph().links, function(link) {
            return (link.from === target.id && link.to === to) || (link.from === to && link.to === target.id);
          });
          if (!link) {
            Graph.addLink(target.id, to);
          }
          if (_.random(0, 1, true) > 0.5) {
            return Graph.addLink($scope.targets.length, target.id);
          }
        } else {
          return Graph.addLink($scope.targets.length, target.id);
        }
      });
      if (!Graph.isCyclic()) {
        break;
      } else {
        results.push(void 0);
      }
    }
    return results;
  };
  return $scope.generateSchemas = function() {
    var helper, sourceLinks, treeV;
    helper = function(treeV) {
      var links, target;
      target = _.find($scope.targets, {
        id: treeV
      });
      target.ip = target.sph / 10 / Math.sqrt(3);
      target.visited = true;
      links = _.filter(Graph.getGraph().links, function(link) {
        return link.from !== $scope.targets.length && (link.from === treeV || link.to === treeV) && !link.visited;
      });
      _.each(links, function(link) {
        var newTreeV, r, targetR;
        link.visited = true;
        newTreeV = link.from === treeV ? link.to : link.from;
        r = helper(newTreeV);
        targetR = _.find($scope.targets, {
          id: r
        });
        target.ip += targetR.ip;
        return $scope.fullLinks.push({
          linkName: target.label + " - " + targetR.label,
          ip: targetR.ip,
          j: Transformators.getJ(targetR.u, target.time)
        });
      });
      return treeV;
    };
    while (true) {
      linkTargets();
      _.each($scope.targets, function(target) {
        target.visited = false;
      });
      sourceLinks = _.filter(Graph.getGraph().links, function(link) {
        return link.from === $scope.targets.length;
      });
      $scope.fullLinks = [];
      treeV = _.map(sourceLinks, function(link) {
        return link.to;
      });
      _.each(treeV, function(a) {
        var target;
        target = _.find($scope.targets, {
          id: a
        });
        target.ip = target.sph / 10 / Math.sqrt(3);
        target.visited = true;
        helper(a);
        return $scope.fullLinks.push({
          linkName: "ИП - " + target.label,
          ip: target.ip,
          j: Transformators.getJ(target.u, target.time)
        });
      });
      if (_.every($scope.targets, {
        visited: true
      })) {
        break;
      }
    }
    _.each($scope.fullLinks, function(link) {
      link.f = link.ip / link.j;
      return link.line = Transformators.getLine(link.f, link.ip);
    });
    return drawGraph();
  };
};

angular.module('transformators').controller('LinkMatrixController', LinkMatrixController);

angular.module('transformators').factory('Schemas', function() {
  var getSchemas, schemas, setSchemas;
  schemas = [];
  getSchemas = function() {
    return schemas;
  };
  setSchemas = function(_schemas) {
    return schemas = _schemas;
  };
  return {
    getSchemas: getSchemas,
    setSchemas: setSchemas
  };
}).factory('Graph', function() {
  var _isCyclicUtil, addLink, getGraph, graph, initGraph, isCyclic;
  graph = {
    v: null,
    links: [],
    adg: []
  };
  getGraph = function() {
    return graph;
  };
  initGraph = function(v) {
    var adg, i, j, len, ref;
    adg = [];
    ref = _.range(v);
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      adg.push([]);
    }
    return _.extend(graph, {
      v: v,
      links: [],
      adg: adg
    });
  };
  addLink = function(v, w) {
    graph.links.push({
      from: v,
      to: w
    });
    graph.adg[v].push(w);
    return graph.adg[w].push(v);
  };
  _isCyclicUtil = function(v, visited, parent) {
    var i, j, len, ref;
    visited[v] = true;
    ref = graph.adg[v];
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      if (!visited[i]) {
        if (_isCyclicUtil(i, visited, v)) {
          return true;
        }
      } else if (i !== parent) {
        return true;
      }
    }
    return false;
  };
  isCyclic = function() {
    var i, j, k, len, len1, ref, ref1, u, visited;
    visited = [];
    ref = _.range(graph.v);
    for (j = 0, len = ref.length; j < len; j++) {
      i = ref[j];
      visited[i] = false;
    }
    ref1 = _.range(graph.v);
    for (k = 0, len1 = ref1.length; k < len1; k++) {
      u = ref1[k];
      if (!visited[u]) {
        if (_isCyclicUtil(u, visited, -1)) {
          return true;
        }
      }
    }
    return false;
  };
  return {
    getGraph: getGraph,
    initGraph: initGraph,
    addLink: addLink,
    isCyclic: isCyclic
  };
});

var TransformatorCounterController;

TransformatorCounterController = function($scope, $state, Transformators, TransformatorSources) {
  var validateTargets;
  $scope.targets = Transformators.getTargets();
  $scope.source = Transformators.getSource();
  $scope.addTarget = function() {
    return $scope.targets.push({
      label: "ТП" + ($scope.targets.length + 1),
      r: 15
    });
  };
  validateTargets = function() {
    var isError;
    isError = !_.every($scope.targets, function(target) {
      var t;
      t = target;
      return t.power && t.x && t.y && t.transformatorsCount && t.cos && t.time && t.u;
    });
    isError = isError || !($scope.source.x && $scope.source.y);
    if (isError) {
      return 'Есть незаполненные поля';
    }
    isError = Transformators.countTotalPower($scope.targets) > Transformators.maxPower;
    if (isError) {
      return "Мощность потребителей превышает максимальную (" + Transformators.maxPower + " кВА)";
    }
    isError = _.some($scope.targets, function(target) {
      return target.power > Transformators.maxPower / 2;
    });
    if (isError) {
      return "Мощность одного из потребителей превышает максимальную (" + (Transformators.maxPower / 2) + " кВА)";
    }
  };
  $scope.generateLinkMatrix = function() {
    var error;
    if (error = validateTargets()) {
      Materialize.toast(error, 4000);
      return;
    }
    Transformators.setTargets($scope.targets);
    return $state.go('linkMatrix');
  };
  $scope.findTransformators = function() {
    var error;
    error = validateTargets();
    if (error) {
      Materialize.toast(error, 4000);
      return;
    }
    TransformatorSources.findTransformatorSources($scope.targets);
    return $state.go('transformatorReview');
  };
  $scope.removeTarget = function(index) {
    return $scope.targets.splice(index, 1);
  };
  return $scope.draw = function() {
    var bubbleCart, container, error;
    if (error = validateTargets()) {
      Materialize.toast(error, 4000);
      return;
    }
    container = document.getElementById('data-set');
    return bubbleCart = new Chart(container, {
      type: 'bubble',
      data: {
        datasets: [
          {
            label: 'ИП',
            data: [$scope.source],
            backgroundColor: 'yellow',
            hoverBackgroundColor: 'yellow'
          }, {
            label: 'ТП',
            data: $scope.targets,
            backgroundColor: '#FF6384',
            hoverBackgroundColor: '#FF6384'
          }
        ]
      },
      options: {
        title: {
          display: true,
          text: 'Карта-схема расположения потребителей'
        },
        tooltips: {
          callbacks: {
            title: function(item, datasets) {
              item = item[0];
              return datasets.datasets[item.datasetIndex].data[item.index].label;
            },
            label: function(tooltipItem, data) {
              return "(x: " + tooltipItem.xLabel + "; y: " + tooltipItem.yLabel + ")";
            }
          }
        }
      }
    });
  };
};

angular.module('transformators').controller('TransformatorCounterController', TransformatorCounterController);

var TransformatorReviewController;

TransformatorReviewController = function($scope, $state, TransformatorSources) {
  $scope.sources = TransformatorSources.getTransformatorSources();
  if (!$scope.sources.data) {
    $state.go('transformatorCounter');
  }
  return $scope.findTransformators = function() {
    var transformators;
    transformators = $scope.sources.data;
    return TransformatorSources.findTransformatorSources([].concat(transformators.first.targets, transformators.second.targets));
  };
};

angular.module('transformators').controller('TransformatorReviewController', TransformatorReviewController);

angular.module('transformators').factory('TransformatorSources', function(Transformators) {
  var findTransformatorSources, getTransformatorSources, initTransformatorSources, sources;
  sources = {
    data: null
  };
  initTransformatorSources = function() {
    return sources.data = {
      first: {
        targets: [],
        transformator: null
      },
      second: {
        targets: [],
        transformator: null
      }
    };
  };
  getTransformatorSources = function() {
    return sources;
  };
  findTransformatorSources = function(targets) {
    var isBalanced, isPowered, qTotalPower, results, totalPower, transformators;
    initTransformatorSources();
    totalPower = Transformators.countTotalPower(targets);
    transformators = sources.data;
    results = [];
    while (true) {
      while (true) {
        transformators.first.transformator = Transformators.findTransformator();
        transformators.second.transformator = Transformators.findTransformator();
        isPowered = transformators.first.transformator.power + transformators.second.transformator.power > totalPower;
        qTotalPower = Transformators.countQuarterTotalPower(totalPower);
        isBalanced = transformators.first.transformator.power > qTotalPower && transformators.second.transformator.power > qTotalPower;
        if (isPowered && isBalanced) {
          break;
        }
      }
      _.each(targets, function(target) {
        if (_.random(0, 1, true) < 0.5 && Transformators.countTotalPower(transformators.first.targets) + target.power < transformators.first.transformator.power) {
          return transformators.first.targets.push(target);
        } else {
          return transformators.second.targets.push(target);
        }
      });
      if (transformators.first.transformator.power > Transformators.countTotalPower(transformators.first.targets && transformators.second.transformator.power > Transformators.countTotalPower(transformators.second.targets))) {
        break;
      } else {
        results.push(void 0);
      }
    }
    return results;
  };
  return {
    getTransformatorSources: getTransformatorSources,
    findTransformatorSources: findTransformatorSources
  };
});

angular.module('transformators').factory('Transformators', function() {
  var countQuarterTotalPower, countTotalPower, findTransformator, getJ, getLine, getSource, getTargets, linesList, maxPower, setTargets, source, targets, transformatorList, transformatorTargetList;
  maxPower = 15000;
  targets = [];
  source = {
    label: 'Источник Питания',
    x: null,
    y: null,
    r: 30
  };
  transformatorTargetList = [
    {
      name: 'ТМ-25/10',
      snt: 25,
      px: 0.135,
      pk: 0.6,
      ix: 3.2,
      uk: 4.5
    }, {
      name: 'ТМ-40/10',
      snt: 40,
      px: 0.19,
      pk: 0.88,
      ix: 3,
      uk: 4.5
    }, {
      name: 'ТМ-63/10',
      snt: 63,
      px: 0.265,
      pk: 0.128,
      ix: 2.8,
      uk: 4.5
    }, {
      name: 'ТМ-100/10',
      snt: 100,
      px: 0.365,
      pk: 1.97,
      ix: 2.6,
      uk: 4.5
    }, {
      name: 'ТМ-160/10',
      snt: 160,
      px: 0.565,
      pk: 2.65,
      ix: 2.4,
      uk: 4.5
    }, {
      name: 'ТМ-250/10',
      snt: 250,
      px: 0.82,
      pk: 3.7,
      ix: 2.3,
      uk: 4.5
    }, {
      name: 'ТМ-400/10',
      snt: 400,
      px: 1.05,
      pk: 5.5,
      ix: 2.1,
      uk: 4.5
    }, {
      name: 'ТМ-630/10',
      snt: 630,
      px: 1.56,
      pk: 7.6,
      ix: 2,
      uk: 5.5
    }, {
      name: 'ТМ-1000/10',
      snt: 1000,
      px: 2.45,
      pk: 12.2,
      ix: 1.4,
      uk: 5.5
    }, {
      name: 'ТМ-1600/10',
      snt: 1600,
      px: 3.3,
      pk: 18,
      ix: 1.3,
      uk: 5.5
    }, {
      name: 'ТМ-2500/10',
      snt: 2500,
      px: 4.6,
      pk: 25,
      ix: 1,
      uk: 5.5
    }, {
      name: 'ТМ-4000/10',
      snt: 4000,
      px: 6.4,
      pk: 33.5,
      ix: 0.9,
      uk: 5.5
    }, {
      name: 'ТМ-6300/10',
      snt: 6300,
      px: 9,
      pk: 46.5,
      ix: 0.8,
      uk: 6.5
    }, {
      name: 'ТСЗ-160/10',
      snt: 160
    }, {
      name: 'ТСЗ-250/10',
      snt: 250
    }, {
      name: 'ТСЗ-400/10',
      snt: 400
    }, {
      name: 'ТСЗ-630/10',
      snt: 630
    }, {
      name: 'ТСЗ-1000/10',
      snt: 1000
    }, {
      name: 'ТСЗ-1600/10',
      snt: 1600
    }
  ];
  transformatorList = [
    {
      type: 'TM-10/10',
      power: 10
    }, {
      type: 'TM-20/10',
      power: 20
    }, {
      type: 'TM-25/10',
      power: 25
    }, {
      type: 'TM-30/10',
      power: 30
    }, {
      type: 'TM-40/10',
      power: 40
    }, {
      type: 'TM-50/10',
      power: 50
    }, {
      type: 'TM-63/10',
      power: 63
    }, {
      type: 'TM-100/10',
      power: 100
    }, {
      type: 'TM-160/10',
      power: 160
    }, {
      type: 'TM-180/10',
      power: 180
    }, {
      type: 'TM-250/10',
      power: 250
    }, {
      type: 'TM-320/10',
      power: 320
    }, {
      type: 'TM-400/10',
      power: 400
    }, {
      type: 'TM-560/10',
      power: 560
    }, {
      type: 'TM-630/10',
      power: 630
    }, {
      type: 'TM-750/10',
      power: 750
    }, {
      type: 'TM-1000/10',
      power: 1000
    }, {
      type: 'TM-1600/10',
      power: 1600
    }, {
      type: 'TM-1800/10',
      power: 1800
    }, {
      type: 'TM-3200/10',
      power: 3200
    }, {
      type: 'TM-5600/10',
      power: 5600
    }, {
      type: 'TM-6300/10',
      power: 6300
    }, {
      type: 'TM-7500/10',
      power: 7500
    }
  ];
  linesList = [
    {
      cut: 25,
      name: 'A',
      i: 136
    }, {
      cut: 25,
      name: 'AC',
      i: 142
    }, {
      cut: 25,
      name: 'M',
      i: 183
    }, {
      cut: 35,
      name: 'A',
      i: 170
    }, {
      cut: 35,
      name: 'AC',
      i: 175
    }, {
      cut: 35,
      name: 'M',
      i: 223
    }, {
      cut: 50,
      name: 'AC',
      i: 210
    }, {
      cut: 50,
      name: 'A',
      i: 215
    }, {
      cut: 50,
      name: 'M',
      i: 275
    }, {
      cut: 70,
      name: 'AC',
      i: 265
    }, {
      cut: 70,
      name: 'M',
      i: 337
    }, {
      cut: 95,
      name: 'A',
      i: 320
    }, {
      cut: 95,
      name: 'AC',
      i: 330
    }, {
      cut: 95,
      name: 'A',
      i: 375
    }, {
      cut: 95,
      name: 'AC',
      i: 390
    }, {
      cut: 95,
      name: 'M',
      i: 422
    }, {
      cut: 95,
      name: 'M',
      i: 485
    }, {
      cut: 120,
      name: 'AC',
      i: 375
    }, {
      cut: 120,
      name: 'A',
      i: 440
    }, {
      cut: 120,
      name: 'AC',
      i: 450
    }, {
      cut: 120,
      name: 'M',
      i: 570
    }, {
      cut: 150,
      name: 'AC',
      i: 450
    }, {
      cut: 150,
      name: 'A',
      i: 500
    }, {
      cut: 150,
      name: 'AC',
      i: 520
    }, {
      cut: 150,
      name: 'M',
      i: 650
    }, {
      cut: 185,
      name: 'AC',
      i: 510
    }, {
      cut: 185,
      name: 'AC',
      i: 515
    }, {
      cut: 185,
      name: 'A',
      i: 590
    }, {
      cut: 185,
      name: 'AC',
      i: 605
    }, {
      cut: 185,
      name: 'M',
      i: 760
    }, {
      cut: 240,
      name: 'AC',
      i: 610
    }, {
      cut: 240,
      name: 'A',
      i: 680
    }, {
      cut: 240,
      name: 'AC',
      i: 710
    }, {
      cut: 240,
      name: 'M',
      i: 880
    }, {
      cut: 300,
      name: 'AC',
      i: 680
    }, {
      cut: 300,
      name: 'AC',
      i: 690
    }, {
      cut: 330,
      name: 'AC',
      i: 730
    }, {
      cut: 330,
      name: 'A',
      i: 815
    }, {
      cut: 330,
      name: 'AC',
      i: 830
    }, {
      cut: 330,
      name: 'M',
      i: 1050
    }, {
      cut: 400,
      name: 'AC',
      i: 825
    }, {
      cut: 400,
      name: 'AC',
      i: 860
    }, {
      cut: 400,
      name: 'AC',
      i: 960
    }, {
      cut: 400,
      name: 'A',
      i: 980
    }, {
      cut: 500,
      name: 'AC',
      i: 945
    }, {
      cut: 600,
      name: 'AC',
      i: 1050
    }, {
      cut: 600,
      name: 'A',
      i: 1100
    }, {
      cut: 700,
      name: 'AC',
      i: 1180
    }
  ];
  getTargets = function() {
    return targets;
  };
  getSource = function() {
    return source;
  };
  setTargets = function(_targets) {
    _.each(_targets, function(target, index) {
      var qk, qx, tg;
      target.id = index;
      target.links = _.map(_targets, function() {
        return 'unblocked';
      });
      target.linksLength = [];
      target.links[index] = 'blocked';
      tg = Math.sqrt(1 - Math.pow(target.cos, 2)) / target.cos;
      target.qp = target.power * tg;
      target.sp = Math.sqrt(Math.pow(target.power, 2) + Math.pow(target.qp, 2));
      target.sn = _.find(transformatorTargetList, function(tr) {
        return tr.snt >= target.sp / target.transformatorsCount;
      });
      target.kn = target.sp / (target.transformatorsCount * target.sn.snt);
      qx = target.sn.ix * target.sn.snt / 100;
      qk = target.sn.uk * target.sn.snt / 100;
      if (target.transformatorsCount - 1) {
        target.ka = target.sp / target.sn.snt;
        target.pt = 2 * target.sn.px + 0.5 * target.sn.pk * Math.pow(target.sp / target.sn.snt, 2);
        target.qt = 2 * qx + 0.5 * qk * Math.pow(target.sp / target.sn.snt, 2);
      } else {
        target.ka = 0;
        target.pt = target.sn.px + target.sn.pk * Math.pow(target.sp / target.sn.snt, 2);
        target.qt = qx + qk * Math.pow(target.sp / target.sn.snt, 2);
      }
      target.pph = target.power + target.pt;
      target.qph = target.qp + target.qt;
      return target.sph = Math.sqrt(Math.pow(target.pph, 2) + Math.pow(target.qph, 2));
    });
    _.each(_targets, function(target) {
      return _.each(_targets, function(_target) {
        var length;
        length = Math.sqrt(Math.pow(_target.x - target.x, 2) + Math.pow(_target.y - target.y, 2));
        return target.linksLength[_target.id] = +length.toFixed(2);
      });
    });
    return targets = _targets;
  };
  findTransformator = function() {
    var transformatorIndex;
    transformatorIndex = _.round(transformatorList.length * _.random(0, 1, true));
    if (transformatorIndex === transformatorList.length) {
      transformatorIndex -= 1;
    }
    return transformatorList[transformatorIndex];
  };
  countTotalPower = function(targets) {
    return _.sumBy(targets, 'power');
  };
  countQuarterTotalPower = function(totalPower) {
    return totalPower * 0.25;
  };
  getJ = function(u, t) {
    if (u > 10) {
      if (t < 3000) {
        return 1.6;
      } else if (t >= 3000 && t < 5000) {
        return 1.4;
      } else {
        return 1.2;
      }
    } else {
      if (t < 3000) {
        return 1.3;
      } else if (t >= 3000 && t < 5000) {
        return 1.1;
      } else {
        return 1.0;
      }
    }
  };
  getLine = function(f, i) {
    var count, line;
    count = Math.ceil(i / 1080);
    i = i / count;
    line = _.find(linesList, function(line) {
      return line.cut > f && line.i > i;
    });
    if (!line) {
      line = _.find(linesList, function(line) {
        return line.i > i;
      });
    }
    line.count = count;
    return line;
  };
  return {
    getTargets: getTargets,
    setTargets: setTargets,
    getSource: getSource,
    findTransformator: findTransformator,
    countTotalPower: countTotalPower,
    countQuarterTotalPower: countQuarterTotalPower,
    maxPower: maxPower,
    getJ: getJ,
    getLine: getLine
  };
});
